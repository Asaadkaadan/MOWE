%% 20-module spherical array
% close all; clear all;

N = 20;  % number of modules

% Read data from file
fileID = fopen('active2.txt');
rawdata = hex2dec(textscan(fileID, '%2c'));
lenRaw = length(rawdata)-rem(length(rawdata),2*N); % Trim the data for integer number of scans
data = zeros(lenRaw/2,1);
modules = zeros(N,lenRaw/(2*N));
k = 0;
for i = 1 : 2 : lenRaw
    k = k + 1;
    data(k) = 256 * rawdata(i) + rawdata(i+1);
end
j = 0; k = 1;
for i = 1 : length(data)
    j = j + 1; 
    if (j == N+1)
        j = 1;
        k = k + 1;
    end   
    modules(j,k) = data(i);  
end

%% Module locations
% Normalized Truncated Icosahedron Centered at (0,0,0)
%%% Face Centers
centers = [0.1716    0.5283   -0.7271;...
   -0.2596   -0.7990   -0.4200;...
    0.6796    0.4938   -0.4200;...
    0.5554   -0.0000   -0.7271;...
    0.8987   -0.0000   -0.1716;...
    0.6796   -0.4938   -0.4200;...
    0.1716   -0.5283   -0.7271;...
   -0.7271   -0.5283   -0.1716;...
    0.0000   -0.0000   -0.9392;...
   -0.4494   -0.3265   -0.7271;...
   -0.4494    0.3265   -0.7271;...
    0.2777    0.8547   -0.1716;...
   -0.6796   -0.4938    0.4200;...
    0.4494    0.3265    0.7271;...
    0.7271    0.5283    0.1716;...
    0.2777   -0.8547   -0.1716;...
   -0.2596    0.7990   -0.4200;...
   -0.8401    0.0000   -0.4200;...
    0.8401    0.0000    0.4200;...
    0.4494   -0.3265    0.7271;...
    0.7271   -0.5283    0.1716;...
   -0.1716   -0.5283    0.7271;...
    0.2596   -0.7990    0.4200;...
   -0.2777   -0.8547    0.1716;...
   -0.7271    0.5283   -0.1716;...
   -0.8987    0.0000    0.1716;...
   -0.0000    0.0000    0.9392;...
   -0.5554    0.0000    0.7271;...
   -0.6796    0.4938    0.4200;...
    0.2596    0.7990    0.4200;...
   -0.2777    0.8547    0.1716;...
   -0.1716    0.5283    0.7271];

%%% Face Normals
normals = [0.1876    0.5774   -0.7947;...
   -0.2764   -0.8507   -0.4472;...
    0.7236    0.5257   -0.4472;...
    0.6071    0.0000   -0.7947;...
    0.9822         0   -0.1876;...
    0.7236   -0.5257   -0.4472;...
    0.1876   -0.5774   -0.7947;...
   -0.7947   -0.5774   -0.1876;...
         0         0   -1.0000;...
   -0.4911   -0.3568   -0.7947;...
   -0.4911    0.3568   -0.7947;...
    0.3035    0.9342   -0.1876;...
   -0.7236   -0.5257    0.4472;...
    0.4911    0.3568    0.7947;...
    0.7947    0.5774    0.1876;...
    0.3035   -0.9342   -0.1876;...
   -0.2764    0.8507   -0.4472;...
   -0.8944         0   -0.4472;...
    0.8944   -0.0000    0.4472;...
    0.4911   -0.3568    0.7947;...
    0.7947   -0.5774    0.1876;...
   -0.1876   -0.5774    0.7947;...
    0.2764   -0.8507    0.4472;...
   -0.3035   -0.9342    0.1876;...
   -0.7947    0.5774   -0.1876;...
   -0.9822    0.0000    0.1876;...
         0         0    1.0000;...
   -0.6071    0.0000    0.7947;...
   -0.7236    0.5257    0.4472;...
    0.2764    0.8507    0.4472;...
   -0.3035    0.9342    0.1876;...
   -0.1876    0.5774    0.7947];

% Pentagon Faces
penta = [2 3 6 9 13 17 18 19 23 27 29 30];

% Hexagon Faces (arranged according to module order)
hexa = [1 12 15 14 4 5 21 20 7 16 24 22 11 25 31 32 10 8 26 28];

% 30mm modules, sphere diameter = 84mm, hexagons
modloc = centers(hexa,:) * (84/2);

%% Visualization
figure; 
% hold on;
% axis equal; 
% view([126 14]);
M = struct('cdata',{},'colormap',{});

% % Create video object
% %writerObj = VideoWriter('20_sphere_background2.mp4','MPEG-4');
% writerObj = VideoWriter('20_sphere_act2_nat');
% writerObj.FrameRate = 48;
% %writerObj.FrameRate = 34;
% open(writerObj);

% Calculate max value (ADC units)
maxVal = 1.0 * max(max(modules));

tic
%for t = 1 : length(modules)
for t = 600 : 800
    
    clf; hold on; colorbar;
    set(gca, 'Clim', [0 maxVal]);
    axis([-50 50 -50 50 -50 50]);
    axis equal; 
%     view([126 14]);
    view([-130 26]);
    
    % plot measured data
    for i = 1 : N
        %plot(modloc(i,1),modloc(i,2),'*','Color',[4096 4096-modules(i,1) 4096-modules(i,1)]/4096)
        %plot3(modloc(i,1),modloc(i,2),modloc(i,3),'*','Color',[maxVal maxVal-modules(i,t) maxVal-modules(i,t)]/maxVal);
        plot3(modloc(i,1),modloc(i,2),modloc(i,3),'*','Color','black');
    end

    % 3D Interpolation
    F = scatteredInterpolant(modloc,modules(:,t),'linear');

    % Evaluate at sphere points
    [X,Y,Z] = sphere(20);   rad = 75/2;
    V = F(X*rad, Y*rad, Z*rad);

    % Plot surface
    mesh(X*rad, Y*rad, Z*rad, V);
    %mesh(X*(84/2), Y*(84/2), Z*(84/2), V, 'FaceAlpha',0.7);
    
    drawnow;
    
%     % Record video
%     M(t) = getframe;
%     % Save video to hard disk
%     writeVideo(writerObj,M(t));

end
    
toc

% close(writerObj);
fclose(fileID);
